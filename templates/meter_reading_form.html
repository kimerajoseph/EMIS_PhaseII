<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Data Submission Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5 justify-content-center">
        <div class="w-75" name="subSelection", id="subSelection">
            <h2 class="text-center">Choose Submission Method</h2>
            <select class="form-control" id="submissionMethod" name="submissionMethod" onchange="toggleForm()">
                <option selected value="default_value">Select Submission Method</option>
                <option value="submitFiles">Submit Files</option>
                <option value="fillOutForm">Fill Out Form</option>
            </select>
        </div>

        <div class="w-75 col-12" name="subFile", id="subFiles">
            <h2 class="text-center">Submit Files</h2>
        
        </div>

        <div class="w-75" name="manualForm", id="manualForm">
            <h2 class="text-center">MONTHLY DATA SUBMISSION FORM</h2>
            <form action="/monthly_billing_data_submission" method="POST" name="manualForm" id="manualForm">
                <div class="row g-3">
                    <div class="col-md-4">
            <label class="form-label">Select Category</label>
            <select class="form-control" id="meterCategory" name="meterCategory" onchange="updateOptions()">
                <option selected value="default_value">Select Category</option>
                <option value="Substation">Substation</option>
                <option value="Standalone">Standalone</option>
                <option value="IPP">IPP</option>
            </select>
                    </div>
                    <div class="col-md-4">
                        <label for="selectNode">Select Node</label>
                        <select id="nodeName" class="form-control" name="nodeName" required>
                            <option selected value="default_value">Select Node</option>
                            <!-- <option value="Node1">Node1</option>
                            <option value="Node2">Node2</option> -->
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Billing Period</label>
                        <input type="date" class="form-control" name="billingPeriod">
                    </div>


                    <div class="col-md-4">
                        <label class="form-label">Meter Number</label>
                        <input type="text" class="form-control" name="serialNo" id="meterNumber">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Date & Time of Reading</label>
                        <input type="datetime-local" class="form-control" name="DateTimeOfReading">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Cumulative Import</label>
                        <input type="number" step="any" class="form-control" name="CumulativeImport" required onkeyup="formatNumber(this)">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Cumulative Export</label>
                        <input type="number" step="any" class="form-control" name="CumulativeExport" required onkeyup="formatNumber(this)">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Rate 1</label>
                        <input type="number" step="any" class="form-control" name="Rate1" required onkeyup="formatNumber(this)">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Rate 2</label>
                        <input type="number" step="any" class="form-control" name="Rate2" required onkeyup="formatNumber(this)">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Rate 3</label>
                        <input type="number" step="any" class="form-control" name="Rate3" required onkeyup="formatNumber(this)">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Rate 4</label>
                        <input type="number" step="any" class="form-control" name="Rate4" onkeyup="formatNumber(this)">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Rate 5</label>
                        <input type="number" step="any" class="form-control" name="Rate5" onkeyup="formatNumber(this)">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Rate 6</label>
                        <input type="number" step="any" class="form-control" name="Rate6" onkeyup="formatNumber(this)">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Max Dem 1</label>
                        <input type="number" step="any" class="form-control" name="MaxDem1" onkeyup="formatNumber(this)">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Max Dem 1 Time</label>
                        <input type="datetime-local" class="form-control" name="MaxDem1DateTime">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Max Dem 2</label>
                        <input type="number" class="form-control" name="MaxDem2" onkeyup="formatNumber(this)">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Max Dem 2 Time</label>
                        <input type="datetime-local" class="form-control" name="MaxDem2DateTime">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Max Dem 3</label>
                        <input type="number" class="form-control" name="MaxDem3" onkeyup="formatNumber(this)">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Max Dem 3 Time</label>
                        <input type="datetime-local" class="form-control" name="MaxDem3DateTime">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Reactive Import</label>
                        <input type="number" step="any" class="form-control" name="ReactiveImport" onkeyup="formatNumber(this)">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Reactive Export</label>
                        <input type="number" step="any" class="form-control" name="ReactiveExport" onkeyup="formatNumber(this)">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Apparent Import</label>
                        <input type="number" step="any" class="form-control" name="ApparentImport" onkeyup="formatNumber(this)">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Number of Resets</label>
                        <input type="number" class="form-control" name="NumberOfResets" onkeyup="formatNumber(this)">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Date of Last Reset</label>
                        <input type="datetime-local" class="form-control" name="DateOfLastReset">
                    </div>
                    <!-- <div class="col-md-4">
                        <label class="form-label">Date and Time Submission</label>
                        <input type="datetime-local" class="form-control" name="DateTime Submission">
                    </div> -->
                    <div class="col-md-4">
                        <label class="form-label">Programming Count</label>
                        <input type="number" class="form-control" name="ProgrammingCount" onkeyup="formatNumber(this)">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">CT Ratio</label>
                        <input type="number" class="form-control" name="CTRatio" step="1" onkeyup="formatNumber(this)">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">VT Ratio</label>
                        <input type="number" class="form-control" name="VTRatio" step="1" onkeyup="formatNumber(this)">
                    </div>
                </div>
                <br>
                <div class="row mt-4">
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary w-100">Submit</button>
                    </div>
                </div>
                <br>
                <br>
            </form>

        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

<style>
    input.form-control {
        border: 1px solid rgb(18, 18, 18);
    }
</style>
<script>
    var meterNo = ""
    var meterType = ""
    var lastMonthCumulativeImport = 0.0
    var lastMonthCumulativeExport = 0.0

    // loading metering node options
    function updateOptions() {
    console.log("function called")
    var selectedCategory = document.getElementById('meterCategory').value;
    console.log(selectedCategory)
    var availableNodes = document.getElementById('nodeName');
    $.ajax({
        url: '/get_options',  // Flask endpoint
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ category: selectedCategory }),  // Send category data
        dataType: 'json',
            success: function (data) {
                console.log("function data",data);
                availableNodes.innerHTML = "";
                //availableNodes.append('<option value="default_value" selected>--Select an Option--</option>'); // Default placeholder
                availableNodes.innerHTML = `<option value="default_value" selected>Select an option</option>`   
                data.forEach(data => {
                    var opt = document.createElement('option');
                    opt.value = data;
                    opt.innerHTML = data;
                    availableNodes.appendChild(opt);
                });
            },
            error: function () {
                alert('Failed to fetch options');
            }
        });
    }


    // form validation on submission
    document.querySelector('form').addEventListener('submit', function(event) {
        var rate1 = parseFloat(document.querySelector('input[name="Rate1"]').value);
        var rate2 = parseFloat(document.querySelector('input[name="Rate2"]').value);
        var rate3 = parseFloat(document.querySelector('input[name="Rate3"]').value);
        var cumulativeImport = parseFloat(document.querySelector('input[name="CumulativeImport"]').value);

        var rate4 = parseFloat(document.querySelector('input[name="Rate4"]').value);
        var rate5 = parseFloat(document.querySelector('input[name="Rate5"]').value);
        var rate6 = parseFloat(document.querySelector('input[name="Rate6"]').value);
        var cumulativeExport = parseFloat(document.querySelector('input[name="CumulativeExport"]').value);
        
        console.log(`meter type is: ${meterType}`)
        if (meterType === "LG E650"){
           console.log(`meter type is: ${meterType}`)
            //console.log("computing for LG E650")
            var netCumulativeExport = cumulativeExport - lastMonthCumulativeExport;
            var netCumulativeImport = cumulativeImport - lastMonthCumulativeImport ;
            cumulativeExport = netCumulativeExport;
            cumulativeImport = netCumulativeImport;
          }

        if (rate1 + rate2 + rate3 !== cumulativeImport) {
            alert("Please confirm Rates 1 - 3. Make sure they equal to cumulative import");
            event.preventDefault();
            return;
        }

        if (rate4 + rate5 + rate6 !== cumulativeExport) {
            alert("Please confirm Rates 4 - 6. Make sure they equal to cumulative export");
            event.preventDefault();
        }      
    });


    // add event listener to the form

document.getElementById('meterNumber').addEventListener('blur', function() {
    var meterNumber = this.value;
    console.log(meterNumber)
    if (meterNumber) {
        $.ajax({
        url: '/monthly_data_validation',  // Flask endpoint
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ meter_no: meterNumber }),  // Send meter number
        dataType: 'json',
            success: function (data) {
           console.log(data)
           lastMonthCumulativeImport = parseFloat(data.cumulative_import);
           lastMonthCumulativeExport = parseFloat(data.cumulative_export);
           meterType = data.meter_type;
           console.log(typeof lastMonthCumulativeExport, typeof lastMonthCumulativeImport, meterType)
            },

            error: function () {
                alert('Failed to fetch options');
            }
        });
    }
    else{
        alert('Please Enter Meter number First')
    }
});
    
// const regex = /^\d+$/;
// document.querySelector('form').addEventListener('input[type="number"]', function(event) {
// //document.querySelectorAll('input[type="number"]'), function(event) {
//     const inputValue = event.target.value;
//     console.log(inputValue)
  
//    if (!regex.test(inputValue)) {
//         alert("Please enter only number. No + or - signs allowed");
//         //event.target.value = inputValue.replace(/[+-]/g, '');
//         event.target.value = inputValue.toString().replace(/[+-]/g, '');
//     } 
//   });    

// REMOVE + - SIGNS FROM NUMBERS
function formatNumber(input) {
            input.value = input.value.replace(/[+-]/g, "");
        }

</script>