<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Submission Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
</head>
<body>

<div class="container mt-5">
    <!-- Submission Method Selection -->
    <div class="col-12 text-center">
        <h2>Choose Submission Method</h2>
        <br>
        <select class="form-control w-50 mx-auto" id="submissionMethod" name="submissionMethod" onchange="toggleForm()">
            <option selected value="default_value">Select Submission Method</option>
            <option value="submitFiles">Submit Files</option>
            <option value="fillOutForm">Fill Out Form</option>
        </select>
    </div>

    <!-- Submit Files Form -->
<!-- Submit Files Form -->
<div class="col-12 mt-4" id="fileFormContainer" style="display: none;">
    <br>
    <h2 class="text-center">Submit Energy Meter Download Files</h2>
    <br>
    <form action="/submit_files" method="POST" enctype="multipart/form-data" id="fileForm" name="fileForm">
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Select Category</label>
                <select class="form-control" id="meterCategoryFile" name="meterCategoryFile" onchange="updateOptions(this)">
                    <option selected value="default_value">Select Category</option>
                    <option value="Substation">Substation</option>
                    <option value="Standalone">Standalone</option>
                    <option value="IPP">IPP</option>
                </select>
            </div>
           
            <div class="col-md-4">          
                    <label for="subIppNameFile" id="subIppNameFileLabel" class="form-label">Ipp/Substation name</label>
                    <select id="subIppNameFile" class="form-control" name="subIppNameFile" onchange="updateNodeOptions(this)" required>
                        <option selected value="default_value">Select Meter Category</option>
                       
                    </select>                
            </div>
            <div class="col-md-4">
                <label class="form-label">Select Node</label>
                <select id="nodeNameFile" class="form-control" name="nodeNameFile" required>
                    <option selected value="default_value">Select Node</option>
                </select>
            </div>
        
        </div>
<br>
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Billing Period</label>
                <input type="date" class="form-control" name="billingPeriodFile">
            </div>
            <div class="col-md-4">
                <label class="form-label">Upload Files</label>
                <input class="form-control" type="file" id="fileInput" name="fileInput" accept=".csv, .xls, .xlsx" multiple>
                </div>
            </div>      
     
        <br>
        <button type="submit" class="btn btn-primary w-100">Submit Files</button>
    </form>
    <br>
</div>

    <!-- Manual Form -->
    <div class="col-12" name="manualForm", id="manualFormContainer" style="display: none;">
        <br>
        <br>
        <h2 class="text-center">MONTHLY DATA SUBMISSION FORM</h2>
        <br>
        <form action="/monthly_billing_data_submission" method="POST" name="manualForm" id="manualForm">
            <div class="row g-3">
                <div class="col-md-4">
        <label class="form-label">Select Category</label>
        <select class="form-control" id="meterCategoryManual" name="meterCategoryManual" onchange="updateOptions(this)">
            <option selected value="default_value">Select Category</option>
            <option value="Substation">Substation</option>
            <option value="Standalone">Standalone</option>
            <option value="IPP">IPP</option>
        </select>
                </div>
            </div>
<br>
                <div class="row g-3">

                <div class="form-group col-md-4">
                    <label for="subIppNameManual" id="meterCategoryLabel">Ipp/Substation name</label>
                    <select id="subIppNameManual" class="form-control" name="subIppNameManual" onchange="updateNodeOptions(this)" required>
                        <option selected value="default_value">Select Meter Category</option>
                       
                    </select>
                </div>

                <div class="col-md-4">
                    <label for="selectNode">Select Node</label>
                    <select id="nodeNameManual" class="form-control" name="nodeNameManual" required>
                        <option selected value="default_value">Select Node</option>
                        <!-- <option value="Node1">Node1</option>
                        <option value="Node2">Node2</option> -->
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Billing Period</label>
                    <input type="date" class="form-control" name="billingPeriodManual">
                </div>


                <div class="col-md-4">
                    <label class="form-label">Meter Number</label>
                    <input type="text" class="form-control" name="serialNo" id="meterNumber">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Date & Time of Reading</label>
                    <input type="datetime-local" class="form-control" name="DateTimeOfReading">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Cumulative Import</label>
                    <input type="number" step="any" class="form-control" name="CumulativeImport" required onkeyup="formatNumber(this)">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Cumulative Export</label>
                    <input type="number" step="any" class="form-control" name="CumulativeExport" required onkeyup="formatNumber(this)">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Rate 1</label>
                    <input type="number" step="any" class="form-control" name="Rate1" required onkeyup="formatNumber(this)">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Rate 2</label>
                    <input type="number" step="any" class="form-control" name="Rate2" required onkeyup="formatNumber(this)">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Rate 3</label>
                    <input type="number" step="any" class="form-control" name="Rate3" required onkeyup="formatNumber(this)">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Rate 4</label>
                    <input type="number" step="any" class="form-control" name="Rate4" onkeyup="formatNumber(this)">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Rate 5</label>
                    <input type="number" step="any" class="form-control" name="Rate5" onkeyup="formatNumber(this)">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Rate 6</label>
                    <input type="number" step="any" class="form-control" name="Rate6">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Max Dem 1</label>
                    <input type="number" step="any" class="form-control" name="MaxDem1">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Max Dem 1 Time</label>
                    <input type="datetime-local" class="form-control" name="MaxDem1DateTime">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Max Dem 2</label>
                    <input type="number" class="form-control" name="MaxDem2" >
                </div>
                <div class="col-md-4">
                    <label class="form-label">Max Dem 2 Time</label>
                    <input type="datetime-local" class="form-control" name="MaxDem2DateTime">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Max Dem 3</label>
                    <input type="number" class="form-control" name="MaxDem3" >
                </div>
                <div class="col-md-4">
                    <label class="form-label">Max Dem 3 Time</label>
                    <input type="datetime-local" class="form-control" name="MaxDem3DateTime">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Reactive Import</label>
                    <input type="number" step="any" class="form-control" name="ReactiveImport" >
                </div>
                <div class="col-md-4">
                    <label class="form-label">Reactive Export</label>
                    <input type="number" step="any" class="form-control" name="ReactiveExport" >
                </div>
                <div class="col-md-4">
                    <label class="form-label">Apparent Import</label>
                    <input type="number" step="any" class="form-control" name="ApparentImport" >
                </div>
                <div class="col-md-4">
                    <label class="form-label">Number of Resets</label>
                    <input type="number" class="form-control" name="NumberOfResets" >
                </div>
                <div class="col-md-4">
                    <label class="form-label">Date of Last Reset</label>
                    <input type="datetime-local" class="form-control" name="DateOfLastReset">
                </div>
                <!-- <div class="col-md-4">
                    <label class="form-label">Date and Time Submission</label>
                    <input type="datetime-local" class="form-control" name="DateTime Submission">
                </div> -->
                <div class="col-md-4">
                    <label class="form-label">Programming Count</label>
                    <input type="number" class="form-control" name="ProgrammingCount" >
                </div>
                <div class="col-md-4">
                    <label class="form-label">CT Ratio</label>
                    <input type="number" class="form-control" name="CTRatio" step="1">
                </div>
                <div class="col-md-4">
                    <label class="form-label">VT Ratio</label>
                    <input type="number" class="form-control" name="VTRatio" step="1" >
                </div>
            </div>
            <br>
            <div class="row mt-4">
                <div class="col-12">
                    <button type="submit" class="btn btn-primary w-100">Submit</button>
                </div>
                <br>
                <br>
            </div>
            <br>
            <br>
        </form>

    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>

<style>
    input.form-control, select.form-control {
        border: 1px solid rgb(18, 18, 18);
    }
</style>

<script>
    function toggleForm() {
        let submissionMethod = document.getElementById("submissionMethod").value;
        document.getElementById("fileFormContainer").style.display = submissionMethod === "submitFiles" ? "block" : "none";
        document.getElementById("manualFormContainer").style.display = submissionMethod === "fillOutForm" ? "block" : "none";

    }
    // Function to format number inputs
    function formatNumber(input) {
        input.value = input.value.replace(/[^0-9.]/g, "");
    }

    // Attach the function to all number inputs on page load
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener("blur", function () {
                formatNumber(this);
            });
        });
    });

// Reset all forms on page load
    document.addEventListener("DOMContentLoaded", function () {
        // Select all forms and reset them
        document.querySelectorAll("form").forEach(form => {
            form.reset();
        });
    });

// loading metering node options
var meterCategoryManual = document.getElementById('meterCategoryManual');
var availableNodesManual = document.getElementById('nodeNameManual');
var subIppNameManual = document.getElementById('subIppNameManual');

var meterCategoryFile = document.getElementById('meterCategoryFile');
var availableNodesFile = document.getElementById('nodeNameFile');
var subIppNameFile = document.getElementById('subIppNameFile');

var subIppSelectToPopulate = ""

function updateOptions(thisElement) {
        console.log("function called")
    var selectedCategory = thisElement.value;
    var subIppSelect = thisElement.name
    console.log(selectedCategory)
             

    $.ajax({
        url: '/get_node_options',  // Flask endpoint
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ category: selectedCategory }),  // Send category data
        dataType: 'json',
            success: function (data) {
                console.log("function data",data);
                if (data && Array.isArray(data) && data.length > 0 && selectedCategory !== "Standalone") {
                    console.log("CALLED NPT STN")
                    if ( subIppSelect === "subIppNameManual") {
                        subIppSelectToPopulate = subIppNameManual
                    }
                    else if (subIppSelect === "subIppNameFile"){
                        subIppSelectToPopulate = subIppNameFile
                    }                    
                    console.log("input to populate", subIppSelectToPopulate)
                    subIppSelectToPopulate.style.display = "block";
                    subIppSelectToPopulate.innerHTML = "";
                    availableNodesManual.innerHTML = ""       
                    availableNodesFile.innerHTML = ""  
                //availableNodes.append('<option value="default_value" selected>--Select an Option--</option>'); // Default placeholder
                subIppSelectToPopulate.innerHTML = `<option value="default_value" selected>Select an option</option>`   
                data.forEach(item => {
                    var opt = document.createElement('option');
                    opt.value = item["name"].toLowerCase();
                    // convert data.name to lower case and set it as the option text                        
                    opt.innerHTML = item["name"].toLowerCase();
                    subIppSelectToPopulate.appendChild(opt);
                });
            }

            else if (data && Array.isArray(data) && data.length > 0 && selectedCategory === "Standalone"){
                sub_ipp_name.style.display = "none";
                availableNodes.innerHTML = `<option value="default_value" selected>Select an option</option>`   
                data.forEach(item => {
                    var opt = document.createElement('option');
                    opt.value = item["name"].toLowerCase();
                    // convert data.name to lower case and set it as the option text                        
                    opt.innerHTML = item["name"].toLowerCase();
                    availableNodes.appendChild(opt);
                });
            }
        },
            error: function () {
                alert('Failed to fetch options');
            }
        });
    }

// populate substation and IPP nodes
function updateNodeOptions(thisElement) {
        console.log("function called")
    var selectedCategory = document.getElementById('meterCategory').value;
    var selected_ipp_substation = thisElement.value;     
    var inputName = thisElement.name;
    var selectElementToPopulate = ""
    
    console.log(selectedCategory,selected_ipp_substation)
   
    $.ajax({
        url: '/get_ipp_substation_nodes',  // Flask endpoint
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ ipp_substation: selected_ipp_substation,category:selectedCategory }), 
        dataType: 'json',
            success: function (data) {
                console.log("function data",data);
                sub_ipp_name.style.display = "block";
                    if(inputName === 'sub_ipp_name'){
                        selectElementToPopulate = document.getElementById('nodeNameFile');
                        
                    }
                    else{
                        selectElementToPopulate = document.getElementById('nodeName');
                    }
                    selectElementToPopulate.innerHTML = "";
                if (data && Array.isArray(data) && data.length > 0 ) {
                
                    
                //availableNodes.append('<option value="default_value" selected>--Select an Option--</option>'); // Default placeholder
                selectElementToPopulate.innerHTML = `<option value="default_value" selected>Select an option</option>`   
                data.forEach(item => {
                    var opt = document.createElement('option');
                    opt.value = item["name"].toLowerCase();
                    // convert data.name to lower case and set it as the option text                        
                    opt.innerHTML = item["name"].toLowerCase();
                    selectElementToPopulate.appendChild(opt);
                });
            }

   else{
    alert("No nodes to display. Please add nodes first")
    selectElementToPopulate.innerHTML = "";
   }
        },
            error: function () {
                alert('Failed to fetch options');
            }
        });
    }







// form validation for file submission
document.getElementById("fileForm").addEventListener("submit", function(event) {
    event.preventDefault(); // Prevent form submission until validation is done

    let fileInput = document.getElementById("fileInput");
    let files = fileInput.files;
    console.log(files[0].name, files[1].name);

    if (files.length !== 2) {
        alert("You must upload exactly two files.");
        return;
    }

    function getFirstWord(filename) {
        return filename.split("_")[0]; // Extract first word before "_"
    }

    let firstWord1 = getFirstWord(files[0].name);
    let firstWord2 = getFirstWord(files[1].name);

    if (firstWord1 !== firstWord2) {
        alert("Files are not from the same energy meter.");
        return;
    }

    alert("Files are valid! Proceeding...");
    // If valid, you can submit the form programmatically
    // event.target.submit();
});


// form validation for manual submission
// add event listener to the form to check values of all select elements. if value is equal to default_value, alert
//  user to select an option
// document.getElementById("manualForm").addEventListener("submit", function(event) {
//   // Prevent form submission until validation is done
//     let form = document.getElementById("manualForm");
//     let selectElements = form.querySelectorAll("select");

//     selectElements.forEach(selectElement => {
//         if (selectElement.value === "default_value") {
//             alert("Please select an option for all select elements.");
//             selectElement.style.border = "1px solid red";
//             event.preventDefault(); 
//         }
//         else{
//             selectElement.style.border = "1px solid black";
//             event.target.submit();

//         }
//     });

//     let dateInputs = document.querySelectorAll("#manualForm input[type='date'], #manualForm input[type='datetime-local']");
//     dateInputs.forEach(dateInput => {
//         if (dateInput.value === "") {
//             alert("Please fill out all date inputs.");
//             dateInput.style.border = "1px solid red";
//             event.preventDefault(); 
//         }
//         else{
//             dateInput.style.border = "1px solid black";
//             event.target.submit();
//         }
//     });

    
//     // If valid, you can submit the form programmatically
//     // event.target.submit();
// });


document.getElementById("manualForm").addEventListener("submit", function(event) {
    event.preventDefault(); // Stop form submission initially
    let form = document.getElementById("manualForm");
    let selectElements = form.querySelectorAll("select");
    let dateInputs = form.querySelectorAll("input[type='date'], input[type='datetime-local']");
    
    let isValid = true; // Flag to track validation
    let errorMessage = ""; // Store all error messages

    // Validate all select elements
    selectElements.forEach(selectElement => {
        if (selectElement.value === "default_value") {
            selectElement.style.border = "1px solid red";
            isValid = false;
            errorMessage = "Please select an option for all select elements.";
        } else {
            selectElement.style.border = "1px solid black"; // Reset border
        }
    });

    // Validate all date inputs
    dateInputs.forEach(dateInput => {
        if (dateInput.value === "") {
            dateInput.style.border = "1px solid red";
            isValid = false;
            errorMessage = "Please fill out all required date fields.";
        } else {
            dateInput.style.border = "1px solid black"; // Reset border
        }
    });

    // Show error alert if needed
    if (!isValid) {
        alert(errorMessage);
        return;
    }

    // If everything is valid, submit the form
    form.submit();
});

</script>