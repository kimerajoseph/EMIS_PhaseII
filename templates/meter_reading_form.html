<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Data Submission Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5 d-flex justify-content-center">
        <div class="w-75">
            <h2 class="text-center">MONTHLY DATA SUBMISSION FORM</h2>
            <form action="/monthly_billing_data_submission" method="POST">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Meter Number</label>
                        <input type="text" class="form-control" name="Meter Number" id="meterNumber">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Date & Time of Reading</label>
                        <input type="datetime-local" class="form-control" name="Date & Time of Reading">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Cumulative Import</label>
                        <input type="number" step="any" class="form-control" name="Cumulative Import" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Cumulative Export</label>
                        <input type="number" step="any" class="form-control" name="Cumulative Export" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Rate 1</label>
                        <input type="number" step="any" class="form-control" name="Rate 1" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Rate 2</label>
                        <input type="number" step="any" class="form-control" name="Rate 2" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Rate 3</label>
                        <input type="number" step="any" class="form-control" name="Rate 3" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Rate 4</label>
                        <input type="number" step="any" class="form-control" name="Rate 4">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Rate 5</label>
                        <input type="number" step="any" class="form-control" name="Rate 5">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Rate 6</label>
                        <input type="number" step="any" class="form-control" name="Rate 6">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Max Dem 1</label>
                        <input type="number" step="any" class="form-control" name="Max Dem 1">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Max Dem 1 Time</label>
                        <input type="datetime-local" class="form-control" name="Max Dem 1 time">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Max Dem 2</label>
                        <input type="number" class="form-control" name="Max Dem 2">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Max Dem 2 Time</label>
                        <input type="datetime-local" class="form-control" name="Max Dem 2 time">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Max Dem 3</label>
                        <input type="number" class="form-control" name="Max Dem 3">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Max Dem 3 Time</label>
                        <input type="datetime-local" class="form-control" name="Max Dem 3 time">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Reactive Import</label>
                        <input type="number" step="any" class="form-control" name="Reactive Import">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Reactive Export</label>
                        <input type="number" step="any" class="form-control" name="Reactive Export">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Apparent Import</label>
                        <input type="number" step="any" class="form-control" name="Apparent Import">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Number of Resets</label>
                        <input type="number" class="form-control" name="Number of Resets">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Date of Last Reset</label>
                        <input type="datetime-local" class="form-control" name="Date of Last Reset">
                    </div>
                    <!-- <div class="col-md-4">
                        <label class="form-label">Date and Time Submission</label>
                        <input type="datetime-local" class="form-control" name="DateTime Submission">
                    </div> -->
                    <div class="col-md-4">
                        <label class="form-label">Programming Count</label>
                        <input type="number" class="form-control" name="Programming Count">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">CT Ratio</label>
                        <input type="number" class="form-control" name="CT Ratio">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">VT Ratio</label>
                        <input type="number" class="form-control" name="VT Ratio">
                    </div>
                </div>
                <br>
                <div class="row mt-4">
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary w-100">Submit</button>
                    </div>
                </div>
                <br>
                <br>
            </form>

        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

<style>
    input.form-control {
        border: 1px solid rgb(18, 18, 18);
    }
</style>
<script>
    var meterNo = ""
    var meterType = ""
    var lastMonthCumulativeImport = 0.0
    var lastMonthCumulativeExport = 0.0

    // form validation on submission
    document.querySelector('form').addEventListener('submit', function(event) {
        var rate1 = parseFloat(document.querySelector('input[name="Rate 1"]').value);
        var rate2 = parseFloat(document.querySelector('input[name="Rate 2"]').value);
        var rate3 = parseFloat(document.querySelector('input[name="Rate 3"]').value);
        var cumulativeImport = parseFloat(document.querySelector('input[name="Cumulative Import"]').value);

        var rate4 = parseFloat(document.querySelector('input[name="Rate 4"]').value);
        var rate5 = parseFloat(document.querySelector('input[name="Rate 5"]').value);
        var rate6 = parseFloat(document.querySelector('input[name="Rate 6"]').value);
        var cumulativeExport = parseFloat(document.querySelector('input[name="Cumulative Export"]').value);
        
        console.log(`meter type is: ${meterType}`)
        if (meterType === "LG E650"){
           console.log(`meter type is: ${meterType}`)
            //console.log("computing for LG E650")
            var netCumulativeExport = cumulativeExport - lastMonthCumulativeExport;
            var netCumulativeImport = cumulativeImport - lastMonthCumulativeImport ;
            cumulativeExport = netCumulativeExport;
            cumulativeImport = netCumulativeImport;
          }

        if (rate1 + rate2 + rate3 !== cumulativeImport) {
            alert("Please confirm Rates 1 - 3. Make sure they equal to cumulative import");
            event.preventDefault();
            return;
        }

        if (rate4 + rate5 + rate6 !== cumulativeExport) {
            alert("Please confirm Rates 4 - 6. Make sure they equal to cumulative export");
            event.preventDefault();
        }      
    });


    // add event listener to the form

document.getElementById('meterNumber').addEventListener('blur', function() {
    var meterNumber = this.value;
    console.log(meterNumber)
    if (meterNumber) {
        $.ajax({
        url: '/monthly_data_validation',  // Flask endpoint
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ meter_no: meterNumber }),  // Send meter number
        dataType: 'json',
            success: function (data) {
           console.log(data)
           lastMonthCumulativeImport = parseFloat(data.cumulative_import);
           lastMonthCumulativeExport = parseFloat(data.cumulative_export);
           meterType = data.meter_type;
           console.log(typeof lastMonthCumulativeExport, typeof lastMonthCumulativeImport, meterType)
            },

            error: function () {
                alert('Failed to fetch options');
            }
        });
    }
    else{
        alert('Please Enter Meter number First')
    }
});
    
const regex = /^\d+$/;
document.querySelector('form').addEventListener('input', function(event) {
    const inputValue = event.target.value;
    console.log(inputValue)
  
   if (!regex.test(inputValue)) {
        alert("Please enter only number. No + or - signs allowed");
        //event.target.value = inputValue.replace(/[+-]/g, '');
        event.target.value = inputValue.toString().replace(/[+-]/g, '');
    } 
  });    
 
</script>